package com.loadmapguide_backend.domain.location.controller;

import com.loadmapguide_backend.domain.location.dto.LocationRequest;
import com.loadmapguide_backend.domain.location.dto.RealTimeRouteResponse;
import com.loadmapguide_backend.domain.location.service.RealTimeTrafficService;
import com.loadmapguide_backend.global.common.enums.TransportationType;
import com.loadmapguide_backend.global.common.dto.BaseResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Slf4j
@RestController
@RequestMapping("/traffic/realtime")
@RequiredArgsConstructor
public class RealTimeTrafficController {
    
    private final RealTimeTrafficService realTimeTrafficService;
    
    /**
     * ì—¬ëŸ¬ ì¶œë°œì§€ì—ì„œ ëª©ì ì§€ê¹Œì§€ì˜ ì‹¤ì‹œê°„ ê²½ë¡œ ì •ë³´ ì¡°íšŒ
     */
    @PostMapping("/routes")
    public ResponseEntity<BaseResponse<List<RealTimeRouteResponse>>> getRealTimeRoutes(
            @RequestBody List<LocationRequest> origins,
            @RequestParam Double destLatitude,
            @RequestParam Double destLongitude,
            @RequestParam(defaultValue = "PUBLIC_TRANSPORT") TransportationType transportation) {
        
        log.info("ğŸš¦ ì‹¤ì‹œê°„ êµí†µì •ë³´ ìš”ì²­ - ëª©ì ì§€: ({}, {}), êµí†µìˆ˜ë‹¨: {}, ì¶œë°œì§€: {}ê°œ", 
                destLatitude, destLongitude, transportation, origins.size());
        
        try {
            List<RealTimeRouteResponse> routes = realTimeTrafficService.getRealTimeRoutes(
                    origins, destLatitude, destLongitude, transportation);
            
            return ResponseEntity.ok(
                BaseResponse.success(
                    routes,
                    String.format("%dê°œ ê²½ë¡œì˜ ì‹¤ì‹œê°„ êµí†µì •ë³´ë¥¼ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.", routes.size())
                )
            );
            
        } catch (Exception e) {
            log.error("âŒ ì‹¤ì‹œê°„ êµí†µì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
            return ResponseEntity.internalServerError().body(
                BaseResponse.error("ì‹¤ì‹œê°„ êµí†µì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
            );
        }
    }
    
    /**
     * ë‹¨ì¼ ê²½ë¡œì˜ ì‹¤ì‹œê°„ êµí†µì •ë³´ ì¡°íšŒ
     */
    @PostMapping("/route")
    public ResponseEntity<BaseResponse<RealTimeRouteResponse>> getRealTimeRoute(
            @RequestBody LocationRequest origin,
            @RequestParam Double destLatitude,
            @RequestParam Double destLongitude,
            @RequestParam(defaultValue = "PUBLIC_TRANSPORT") TransportationType transportation) {
        
        log.info("ğŸ›£ï¸ ë‹¨ì¼ ê²½ë¡œ ì‹¤ì‹œê°„ ì •ë³´ ìš”ì²­ - {} -> ({}, {}), êµí†µìˆ˜ë‹¨: {}", 
                origin.getAddress(), destLatitude, destLongitude, transportation);
        
        try {
            RealTimeRouteResponse route = realTimeTrafficService.calculateRealTimeRoute(
                    origin, destLatitude, destLongitude, transportation);
            
            return ResponseEntity.ok(
                BaseResponse.success(
                    route,
                    String.format("%s ê²½ë¡œì˜ ì‹¤ì‹œê°„ ì •ë³´ì…ë‹ˆë‹¤.", route.getTransportationIcon())
                )
            );
            
        } catch (Exception e) {
            log.error("âŒ ë‹¨ì¼ ê²½ë¡œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
            return ResponseEntity.internalServerError().body(
                BaseResponse.error("ê²½ë¡œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
            );
        }
    }
    
    /**
     * ì¹´ì¹´ì˜¤ ê¸¸ì°¾ê¸° APIë¡œ ìë™ì°¨ ê²½ë¡œ ì¡°íšŒ
     */
    @GetMapping("/car-route")
    public ResponseEntity<BaseResponse<RealTimeRouteResponse>> getCarRoute(
            @RequestParam Double originLatitude,
            @RequestParam Double originLongitude,
            @RequestParam Double destLatitude,
            @RequestParam Double destLongitude,
            @RequestParam(required = false) String originAddress) {
        
        log.info("ğŸš— ì¹´ì¹´ì˜¤ ìë™ì°¨ ê²½ë¡œ API ìš”ì²­ - ({}, {}) -> ({}, {})", 
                originLatitude, originLongitude, destLatitude, destLongitude);
        
        try {
            LocationRequest origin = LocationRequest.builder()
                    .latitude(originLatitude)
                    .longitude(originLongitude)
                    .address(originAddress != null ? originAddress : "ì¶œë°œì§€")
                    .build();
                    
            RealTimeRouteResponse route = realTimeTrafficService.calculateRealTimeRoute(
                    origin, destLatitude, destLongitude, TransportationType.CAR);
            
            return ResponseEntity.ok(
                BaseResponse.success(
                    route,
                    String.format("ì‹¤ì‹œê°„ ìë™ì°¨ ê²½ë¡œ: %s, êµí†µìƒí™©: %s", 
                            route.getFormattedDuration(), route.getTrafficState())
                )
            );
            
        } catch (Exception e) {
            log.error("âŒ ìë™ì°¨ ê²½ë¡œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
            return ResponseEntity.internalServerError().body(
                BaseResponse.error("ìë™ì°¨ ê²½ë¡œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
            );
        }
    }
    
    /**
     * ëŒ€ì¤‘êµí†µ ê²½ë¡œ ì¡°íšŒ (ì¶”ì •)
     */
    @GetMapping("/public-transport-route")
    public ResponseEntity<BaseResponse<RealTimeRouteResponse>> getPublicTransportRoute(
            @RequestParam Double originLatitude,
            @RequestParam Double originLongitude,
            @RequestParam Double destLatitude,
            @RequestParam Double destLongitude,
            @RequestParam(required = false) String originAddress) {
        
        log.info("ğŸšŒ ëŒ€ì¤‘êµí†µ ê²½ë¡œ ìš”ì²­ - ({}, {}) -> ({}, {})", 
                originLatitude, originLongitude, destLatitude, destLongitude);
        
        try {
            LocationRequest origin = LocationRequest.builder()
                    .latitude(originLatitude)
                    .longitude(originLongitude)
                    .address(originAddress != null ? originAddress : "ì¶œë°œì§€")
                    .build();
                    
            RealTimeRouteResponse route = realTimeTrafficService.calculateRealTimeRoute(
                    origin, destLatitude, destLongitude, TransportationType.PUBLIC_TRANSPORT);
            
            return ResponseEntity.ok(
                BaseResponse.success(
                    route,
                    String.format("ëŒ€ì¤‘êµí†µ ì˜ˆìƒ ê²½ë¡œ: %s, ì˜ˆìƒìš”ê¸ˆ: %s", 
                            route.getFormattedDuration(), route.getFormattedFare())
                )
            );
            
        } catch (Exception e) {
            log.error("âŒ ëŒ€ì¤‘êµí†µ ê²½ë¡œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
            return ResponseEntity.internalServerError().body(
                BaseResponse.error("ëŒ€ì¤‘êµí†µ ê²½ë¡œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
            );
        }
    }
    
    /**
     * ë„ë³´ ê²½ë¡œ ì¡°íšŒ
     */
    @GetMapping("/walking-route")
    public ResponseEntity<BaseResponse<RealTimeRouteResponse>> getWalkingRoute(
            @RequestParam Double originLatitude,
            @RequestParam Double originLongitude,
            @RequestParam Double destLatitude,
            @RequestParam Double destLongitude,
            @RequestParam(required = false) String originAddress) {
        
        log.info("ğŸš¶ ë„ë³´ ê²½ë¡œ ìš”ì²­ - ({}, {}) -> ({}, {})", 
                originLatitude, originLongitude, destLatitude, destLongitude);
        
        try {
            LocationRequest origin = LocationRequest.builder()
                    .latitude(originLatitude)
                    .longitude(originLongitude)
                    .address(originAddress != null ? originAddress : "ì¶œë°œì§€")
                    .build();
                    
            RealTimeRouteResponse route = realTimeTrafficService.calculateRealTimeRoute(
                    origin, destLatitude, destLongitude, TransportationType.WALK);
            
            return ResponseEntity.ok(
                BaseResponse.success(
                    route,
                    String.format("ë„ë³´ ê²½ë¡œ: %s, ê±°ë¦¬: %.1fkm", 
                            route.getFormattedDuration(), route.getDistanceInKm())
                )
            );
            
        } catch (Exception e) {
            log.error("âŒ ë„ë³´ ê²½ë¡œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
            return ResponseEntity.internalServerError().body(
                BaseResponse.error("ë„ë³´ ê²½ë¡œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
            );
        }
    }
    
    /**
     * êµí†µìˆ˜ë‹¨ë³„ í‰ê·  ì´ë™ì‹œê°„ ê³„ì‚°
     */
    @PostMapping("/average-time")
    public ResponseEntity<BaseResponse<Double>> calculateAverageTime(
            @RequestBody List<LocationRequest> origins,
            @RequestParam Double destLatitude,
            @RequestParam Double destLongitude,
            @RequestParam TransportationType transportation) {
        
        log.info("ğŸ“Š í‰ê·  ì´ë™ì‹œê°„ ê³„ì‚° ìš”ì²­ - êµí†µìˆ˜ë‹¨: {}, ì¶œë°œì§€: {}ê°œ", 
                transportation, origins.size());
        
        try {
            Double averageTime = realTimeTrafficService.calculateAverageRealTimeTravelTime(
                    origins, destLatitude, destLongitude, transportation);
            
            return ResponseEntity.ok(
                BaseResponse.success(
                    averageTime,
                    String.format("%s í‰ê·  ì´ë™ì‹œê°„: %.1fë¶„", 
                            transportation.getDescription(), averageTime)
                )
            );
            
        } catch (Exception e) {
            log.error("âŒ í‰ê·  ì´ë™ì‹œê°„ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
            return ResponseEntity.internalServerError().body(
                BaseResponse.error("í‰ê·  ì´ë™ì‹œê°„ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
            );
        }
    }
}